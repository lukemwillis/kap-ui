import { NextApiRequest, NextApiResponse } from "next";
import { isASCII } from "../../../utils/characterSet";
import { toASCII } from "punycode";

export default function generateSvg(req: NextApiRequest, res: NextApiResponse) {
  const { hex } = req.query;

  if (typeof hex === "string" && /^0x([a-fA-F0-9]{2})+$/.test(hex)) {
    const name = Buffer.from(hex.substring(2), "hex").toString("utf8");
    const isAscii = isASCII(name);
    res
      .status(200)
      .setHeader("Cache-Control", "max-age=43200, immutable")
      .setHeader("Content-Type", "image/svg+xml")
      .send(`<?xml version="1.0" encoding="utf-8"?>
            <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                width="500px" height="500px" viewBox="-100 -100 1600 1600" enable-background="new 0 0 708.661 255.118"
                xml:space="preserve">
                <defs>
                    <linearGradient gradientTransform="rotate(60, 0.5, 0.5)" id="gradient">
                        <stop stop-color="#ff4800" stop-opacity="1" offset="0%"></stop>
                        <stop stop-color="#c7007b" stop-opacity="1" offset="50%"></stop>
                        <stop stop-color="#2d388a" stop-opacity="1" offset="100%"></stop>
                    </linearGradient>
                </defs>
                <style>
                    .heavy {
                        font: bold 200px sans-serif;
                    }
                    .light {
                        font: normal 80px sans-serif;
                    }
                </style>
                <rect width="2000" height="2000" fill="url(#gradient)" x="-500" y="-500" />
                <g fill="white">
                    <polygon points="104.687,129.11 113.291,138.4 158.395,88.217 141.441,88.217"/>
                    <polygon points="76.657,114.179 85.657,104.136 85.657,47.201 76.657,47.201"/>
                    <polygon points="157.385,187.467 124.325,187.467 130.774,194.467 163.869,194.467"/>
                    <polygon points="76.657,143.182 76.657,187.467 58.997,187.467 58.997,194.467 85.657,194.467 85.657,152.951"/>
                    <path d="M199.311,155.59c-1.872-4.233-2.814-9.014-2.814-14.346c0-9.115,2.726-16.585,8.176-22.413
                        c5.45-5.826,12.295-8.74,20.537-8.74c2.376,0,4.633,0.236,6.777,0.691c-0.005-0.005-0.01-0.011-0.015-0.017
                        c-4.971-5.164-11.108-7.674-18.762-7.674c-7.441,0-13.442,2.548-18.346,7.79c-4.957,5.3-7.367,11.961-7.367,20.363
                        c0,8.47,2.457,15.21,7.51,20.605C196.365,153.301,197.8,154.542,199.311,155.59z"/>
                    <polygon points="270.895,88.217 270.895,187.467 253.235,187.467 253.235,194.467 279.895,194.467 279.895,88.217"/>
                    <path d="M238.235,187.467v-7.665c-3.812,2.986-7.663,5.297-11.501,6.896c-5.583,2.325-11.697,3.503-18.176,3.503
                        c-5.946,0-11.583-0.971-16.9-2.869c8.492,6.569,18.122,9.869,28.9,9.869c6.112,0,11.786-1.092,17.021-3.271
                        c3.592-1.497,7.177-3.662,10.755-6.463H238.235z"/>
                    <path d="M349.34,103.092c-7.62,0-13.75,2.512-18.741,7.678c-5.019,5.196-7.458,11.861-7.458,20.377
                        c0,8.724,2.445,15.538,7.476,20.834c1.337,1.408,2.759,2.616,4.266,3.639c-1.825-4.229-2.742-9.052-2.742-14.473
                        c0-9.244,2.767-16.732,8.301-22.461c5.533-5.728,12.5-8.594,20.899-8.594c2.221,0,4.336,0.213,6.353,0.627
                        C362.8,105.59,356.795,103.092,349.34,103.092z"/>
                    <path d="M324.313,179.794v46.54h-17.465v7h26.465v-47.809C330.3,184.035,327.292,182.123,324.313,179.794z"/>
                    <path d="M402.259,101.205c-0.975-1.052-1.975-2.038-2.991-2.984c5.672,9.415,8.542,20.573,8.542,33.317
                        c0,16.535-5.334,30.584-15.855,41.754c-10.569,11.221-23.297,16.91-37.829,16.91c-5.5,0-10.746-0.856-15.642-2.531
                        c3.502,2.702,7.02,4.799,10.552,6.26c5.273,2.18,10.969,3.271,17.09,3.271c13.736,0,25.617-5.322,35.645-15.967
                        c10.025-10.645,15.039-23.877,15.039-39.697C416.81,125.131,411.958,111.688,402.259,101.205z"/>
                    <path d="M471.117,87.711c1.121,2.881,1.743,6.01,1.743,9.283c0,14.159-11.519,25.677-25.678,25.677
                        c-1.645,0-3.252-0.162-4.812-0.458c4.149,4.581,10.144,7.458,16.812,7.458c12.525,0,22.678-10.152,22.678-22.677
                        C481.86,98.849,477.564,91.71,471.117,87.711z"/>
                    <path d="M471.117,155.712c1.121,2.881,1.743,6.01,1.743,9.282c0,14.158-11.519,25.677-25.678,25.677
                        c-1.645,0-3.252-0.162-4.812-0.459c4.149,4.581,10.144,7.459,16.812,7.459c12.525,0,22.678-10.152,22.678-22.677
                        C481.86,166.85,477.564,159.711,471.117,155.712z"/>
                    <polygon points="587.657,47.146 514.182,213.146 493.552,213.146 490.453,220.146 524.229,220.146 600.803,47.146"/>
                    <polygon points="660.862,47.146 587.387,213.146 566.757,213.146 563.658,220.146 597.434,220.146 674.008,47.146"/>
                </g>
                <g fill="white">
                    <rect x="49.997" y="40.201" width="20.66" height="141.266"/>
                    <polygon points="145.001,181.467 96.564,129.17 139.665,81.217 114.254,81.217 71.587,128.826 120.089,181.467"/>
                    <path d="M264.895,181.467V81.217h-20.66v16.036l-5.137-5.211c-4.453-4.518-9.352-7.947-14.561-10.19
                        c-5.191-2.235-10.829-3.369-16.758-3.369c-13.097,0-23.927,4.828-33.107,14.759c-9.115,9.861-13.737,22.746-13.737,38.296
                        c0,14.957,4.779,27.622,14.206,37.642c9.51,10.108,20.442,15.022,33.418,15.022c5.683,0,11.021-1.023,15.868-3.041
                        c4.869-2.029,9.829-5.428,14.741-10.098l5.067-4.818v15.223H264.895z M236.312,156.11c-6.079,6.422-13.819,9.678-23.007,9.678
                        c-8.935,0-16.564-3.31-22.678-9.836c-6.059-6.47-9.131-14.782-9.131-24.707c0-9.857,3.023-18.087,8.985-24.462
                        c6.016-6.431,13.663-9.691,22.728-9.691c9.241,0,17.008,3.201,23.085,9.513c6.046,6.282,9.112,14.539,9.112,24.542
                        C245.407,141.335,242.347,149.734,236.312,156.11z"/>
                    <path d="M388.057,93.243c-9.192-9.932-20.036-14.76-33.15-14.76c-5.938,0-11.585,1.134-16.784,3.369
                        c-5.222,2.247-10.164,5.68-14.689,10.205l-5.121,5.122V81.217h-20.465v139.118h20.465V166.25l5.066,4.813
                        c4.915,4.669,9.896,8.065,14.803,10.096c4.886,2.02,10.25,3.044,15.943,3.044c12.993,0,23.938-4.914,33.461-15.023
                        c9.438-10.021,14.223-22.685,14.223-37.641C401.81,115.99,397.183,103.105,388.057,93.243z M372.084,155.956
                        c-6.131,6.524-13.783,9.832-22.744,9.832c-9.214,0-16.977-3.255-23.074-9.674c-6.055-6.375-9.125-14.775-9.125-24.967
                        c0-10.006,3.076-18.265,9.143-24.545c6.095-6.311,13.853-9.51,23.056-9.51c9.156,0,16.857,3.259,22.891,9.687
                        c5.982,6.375,9.016,14.606,9.016,24.466C381.247,141.17,378.164,149.485,372.084,155.956z"/>
                    <path d="M447.183,77.316c-10.85,0-19.677,8.828-19.677,19.678s8.827,19.677,19.677,19.677
                        c10.851,0,19.678-8.827,19.678-19.677S458.033,77.316,447.183,77.316z"/>
                    <path d="M447.183,145.317c-10.85,0-19.677,8.827-19.677,19.678c0,10.85,8.827,19.677,19.677,19.677
                        c10.851,0,19.678-8.827,19.678-19.677C466.86,154.144,458.033,145.317,447.183,145.317z"/>
                    <polygon points="556.98,40.146 483.062,207.146 510.275,207.146 584.194,40.146"/>
                    <polygon points="630.186,40.146 556.267,207.146 583.48,207.146 657.399,40.146"/>
                </g>
                <g fill="white">
                    <text x="50" y="${isAscii ? 1300 : 1200}" class="heavy">${name}</text>
                </g>
                ${
                  !isAscii &&
                  `<g fill="#dddddd">
                     <text x="50" y="1300" class="light">⚠️ ${toASCII(name)}</text>
                   </g>`
                }
            </svg>
        `);
  } else {
    res.status(500).json({ error: "Hex parameter is required" });
  }
}
